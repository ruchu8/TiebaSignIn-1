name: Daily Tieba Sign-In

on:
  workflow_dispatch:
  schedule:
    - cron: '30 22 * * *'  # 北京时间 6:30 (UTC+8)

jobs:
  signin:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 允许工作流修改仓库内容（用于保活提交）

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: true  # 保留凭据用于后续提交

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '8'
          cache: 'maven'

      - name: Build and execute
        env:
          BDUSS: ${{ secrets.BDUSS }}
          SCKEY: ${{ secrets.SCKEY }}
        run: |
          mvn -B compile exec:java \
            -Dexec.mainClass="top.srcrs.Run" \
            -Dexec.args="$BDUSS $SCKEY"

      - name: Keep repository active
        run: |
          # 检查最后一次提交是否超过45天（避免频繁提交）
          last_commit=$(git log -1 --format=%cd --date=unix)
          current_time=$(date +%s)
          days_since_last_commit=$(( (current_time - last_commit) / 86400 ))
          
          if [ $days_since_last_commit -ge 45 ]; then
            # 创建一个空提交保持活跃
            git config --global user.name "GitHub Actions"
            git config --global user.email "actions@github.com"
            git commit --allow-empty -m "Auto-keepalive: Prevent workflow disable"
            git push origin main  # 注意：如果你的主分支是master，这里改为master
          fi
